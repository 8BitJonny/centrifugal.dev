"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[6946],{3905:function(e,n,i){i.d(n,{Zo:function(){return p},kt:function(){return m}});var t=i(7294);function a(e,n,i){return n in e?Object.defineProperty(e,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[n]=i,e}function o(e,n){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),i.push.apply(i,t)}return i}function r(e){for(var n=1;n<arguments.length;n++){var i=null!=arguments[n]?arguments[n]:{};n%2?o(Object(i),!0).forEach((function(n){a(e,n,i[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o(Object(i)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(i,n))}))}return e}function s(e,n){if(null==e)return{};var i,t,a=function(e,n){if(null==e)return{};var i,t,a={},o=Object.keys(e);for(t=0;t<o.length;t++)i=o[t],n.indexOf(i)>=0||(a[i]=e[i]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)i=o[t],n.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(a[i]=e[i])}return a}var l=t.createContext({}),c=function(e){var n=t.useContext(l),i=n;return e&&(i="function"==typeof e?e(n):r(r({},n),e)),i},p=function(e){var n=c(e.components);return t.createElement(l.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},d=t.forwardRef((function(e,n){var i=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(i),m=a,b=d["".concat(l,".").concat(m)]||d[m]||u[m]||o;return i?t.createElement(b,r(r({ref:n},p),{},{components:i})):t.createElement(b,r({ref:n},p))}));function m(e,n){var i=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=i.length,r=new Array(o);r[0]=d;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,r[1]=s;for(var c=2;c<o;c++)r[c]=i[c];return t.createElement.apply(null,r)}return t.createElement.apply(null,i)}d.displayName="MDXCreateElement"},7553:function(e,n,i){i.r(n),i.d(n,{assets:function(){return p},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return u}});var t=i(3117),a=i(102),o=(i(7294),i(3905)),r=["components"],s={id:"capabilities",title:"Channel capabilities"},l=void 0,c={unversionedId:"server/capabilities",id:"server/capabilities",title:"Channel capabilities",description:"At this point you know that Centrifugo allows configuring channel permissions on a per-namespace level. When creating a new real-time feature it's recommended to create a new namespace for it and configure permissions. To achieve a better channel permission control inside a namespace Centrifugo provides possibility to set capabilities on individual connection basis, or individual channel subscription basis.",source:"@site/docs/server/capabilities.md",sourceDirName:"server",slug:"/server/capabilities",permalink:"/docs/next/server/capabilities",draft:!1,editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/server/capabilities.md",tags:[],version:"current",frontMatter:{id:"capabilities",title:"Channel capabilities"},sidebar:"Guides",previous:{title:"Channel token authorization",permalink:"/docs/next/server/channel_token_auth"},next:{title:"Server-side subscriptions",permalink:"/docs/next/server/server_subs"}},p={},u=[{value:"Connection capabilities",id:"connection-capabilities",level:2},{value:"Caps processing behavior",id:"caps-processing-behavior",level:3},{value:"Expiration considirations",id:"expiration-considirations",level:3},{value:"Revoking connection caps",id:"revoking-connection-caps",level:3},{value:"Example: different caps",id:"example-different-caps",level:3},{value:"Example: wildcard match",id:"example-wildcard-match",level:3},{value:"Example: regex match",id:"example-regex-match",level:3},{value:"Example: different types of match",id:"example-different-types-of-match",level:3},{value:"Example: full access to all channels",id:"example-full-access-to-all-channels",level:3},{value:"Subscription capabilities",id:"subscription-capabilities",level:2},{value:"Expiration considirations",id:"expiration-considirations-1",level:3},{value:"Revoking subscription permissions",id:"revoking-subscription-permissions",level:3}],d={toc:u};function m(e){var n=e.components,i=(0,a.Z)(e,r);return(0,o.kt)("wrapper",(0,t.Z)({},d,i,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"At this point you know that Centrifugo allows configuring channel permissions on a per-namespace level. When creating a new real-time feature it's recommended to create a new namespace for it and configure permissions. To achieve a better channel permission control inside a namespace Centrifugo provides possibility to set capabilities on individual connection basis, or individual channel subscription basis."),(0,o.kt)("p",null,"Let's start by looking at connection-wide capabilities first."),(0,o.kt)("h2",{id:"connection-capabilities"},"Connection capabilities"),(0,o.kt)("p",null,"Connection capabilities can be set:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"in connection JWT (in ",(0,o.kt)("inlineCode",{parentName:"li"},"caps")," claim)"),(0,o.kt)("li",{parentName:"ul"},"in connect proxy result (",(0,o.kt)("inlineCode",{parentName:"li"},"caps")," field)")),(0,o.kt)("p",null,"For example, here we are issuing permissions to subscribe on channel ",(0,o.kt)("inlineCode",{parentName:"p"},"news")," and channel ",(0,o.kt)("inlineCode",{parentName:"p"},"user_42")," to a client:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "caps": [\n        {\n            "channel": "news",\n            "allow": ["sub"]\n        },\n        {\n            "channel": "user_42",\n            "allow": ["sub"]\n        },\n    ]\n}\n')),(0,o.kt)("h3",{id:"caps-processing-behavior"},"Caps processing behavior"),(0,o.kt)("p",null,"Centrifugo processes caps objects till it finds a match to a channel. At this point it applies permissions in the matched object and stops processing remaining caps. If no match found \u2013 then ",(0,o.kt)("inlineCode",{parentName:"p"},"103 permission denied")," returned to a client (of course if namespace does not have other permission-related options related). Let's consider example like this:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "caps": [\n        {\n            "channel": "news",\n            "allow": ["pub"]\n        },\n        {\n            "channel": "news",\n            "allow": ["sub"]\n        },\n    ]\n}\n')),(0,o.kt)("p",null,"Here we have two entries for channel ",(0,o.kt)("inlineCode",{parentName:"p"},"news"),", but when client subscribes on ",(0,o.kt)("inlineCode",{parentName:"p"},"news")," only the first entry will be taken into considiration by Centrifugo \u2013 so Subscription attempt will be rejected (since first cap object does not have ",(0,o.kt)("inlineCode",{parentName:"p"},"sub")," capability)."),(0,o.kt)("h3",{id:"expiration-considirations"},"Expiration considirations"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"In JWT auth case \u2013 capabilities in JWT will work till token expiration, that's why it's important to keep reasonably small token expiration times. We can recommend using sth like 5-10 mins as a good expiration value, but of course this is application specific."),(0,o.kt)("li",{parentName:"ul"},"In connect proxy case \u2013 capabilities will work until client connection close (disconnect) or connection refresh triggered (with refresh proxy you can provide an updated set of capabilities).")),(0,o.kt)("h3",{id:"revoking-connection-caps"},"Revoking connection caps"),(0,o.kt)("p",null,"If at some point you need to revoke some capability from a client:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Simplest way is to wait for a connection expiration, then upon refresh:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"if using proxy \u2013 provide new caps in refresh proxy result, Centrifugo will update caps and unsubscribe a client from channels it does not have permissions anymore (",(0,o.kt)("strong",{parentName:"li"},"only those obtained due to previous connection-wide capabilities"),")."),(0,o.kt)("li",{parentName:"ul"},"if JWT auth - provide new caps in connection token, Centrifugo will update caps and unsubscribe a client from channels it does not have permissions anymore (",(0,o.kt)("strong",{parentName:"li"},"only those obtained due to previous connection-wide capabilities"),")."))),(0,o.kt)("li",{parentName:"ul"},"In case of using connect proxy \u2013 you can disconnect a user (or client) with a reconnect code. New capabilities will be asked upon reconnection."),(0,o.kt)("li",{parentName:"ul"},"In case of using token auth \u2013 revoke token (Centrifugo PRO feature) and disconnect user (or client) with reconnect code. Upon reconnection user will receive an error that token revoked and will try to load a new one.")),(0,o.kt)("h3",{id:"example-different-caps"},"Example: different caps"),(0,o.kt)("p",null,"In this example we are issuing permissions to subscribe on channel ",(0,o.kt)("inlineCode",{parentName:"p"},"news")," and channel ",(0,o.kt)("inlineCode",{parentName:"p"},"user_42")," to a client, but for channel ",(0,o.kt)("inlineCode",{parentName:"p"},"user_42")," we additionally give capabilities to publish, call presence and history API."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "caps": [\n        {\n            "channel": "news",\n            "allow": ["sub"]\n        },\n        {\n            "channel": "user_42",\n            "allow": ["sub", "pub", "hst", "prs"]\n        },\n    ]\n}\n')),(0,o.kt)("h3",{id:"example-wildcard-match"},"Example: wildcard match"),(0,o.kt)("p",null,"It's possible to use wildcards in channel resource names. For example, let's give a permission to subscribe on all channels in ",(0,o.kt)("inlineCode",{parentName:"p"},"news")," namespace."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "caps": [\n        {\n            "channel": "news:*",\n            "match": "wildcard",\n            "allow": ["sub"]\n        }\n    ]\n}\n')),(0,o.kt)("h3",{id:"example-regex-match"},"Example: regex match"),(0,o.kt)("p",null,"Or regex:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "caps": [\n        {\n            "channel": "^news:[.*]$",\n            "match": "regex",\n            "allow": ["sub"]\n        }\n    ]\n}\n')),(0,o.kt)("h3",{id:"example-different-types-of-match"},"Example: different types of match"),(0,o.kt)("p",null,"Of course it's possible to combine different types of match inside one ",(0,o.kt)("inlineCode",{parentName:"p"},"caps")," array:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "caps": [\n        {\n            "channel": "^news:[.*]$",\n            "match": "regex",\n            "allow": ["sub"]\n        }\n        {\n            "channel": "user_42",\n            "allow": ["sub"]\n        }\n    ]\n}\n')),(0,o.kt)("h3",{id:"example-full-access-to-all-channels"},"Example: full access to all channels"),(0,o.kt)("p",null,"Let's look how to allow all permissions to a client:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "caps": [\n        {\n            "channel": "*",\n            "match": "wildcard",\n            "allow": ["sub", "pub", "hst", "prs"]\n        }\n    ]\n}\n')),(0,o.kt)("h2",{id:"subscription-capabilities"},"Subscription capabilities"),(0,o.kt)("p",null,"Subscription capabilities can be set:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"in subscription JWT (in ",(0,o.kt)("inlineCode",{parentName:"li"},"allow")," claim)"),(0,o.kt)("li",{parentName:"ul"},"in subscribe proxy result (",(0,o.kt)("inlineCode",{parentName:"li"},"allow")," field)")),(0,o.kt)("p",null,"Subscription token already belongs to a channel (it has a ",(0,o.kt)("inlineCode",{parentName:"p"},"channel")," claim). So users with a valid subscription token can subscribe to a channel. But it's possible to additionally grant channel permissions to a user for publishing and calling presence and history using ",(0,o.kt)("inlineCode",{parentName:"p"},"allow")," claim:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "allow": ["pub", "hst", "prs"]\n}\n')),(0,o.kt)("p",null,"Putting ",(0,o.kt)("inlineCode",{parentName:"p"},"sub")," permission to the Subscription token does not make much sense \u2013 Centrifugo only expects valid token for a subscription permission check."),(0,o.kt)("h3",{id:"expiration-considirations-1"},"Expiration considirations"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"In JWT auth case \u2013 capabilities in subscription JWT will work till token expiration, that's why it's important to keep reasonably small token expiration times. We can recommend using sth like 5-10 mins as a good expiration value, but of course this is application specific."),(0,o.kt)("li",{parentName:"ul"},"In subscribe proxy case \u2013 capabilities will work until client unsubscribe (or connection close).")),(0,o.kt)("h3",{id:"revoking-subscription-permissions"},"Revoking subscription permissions"),(0,o.kt)("p",null,"If at some point you need to revoke some capability from a client:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Simplest way is to wait for a subscription expiration, then upon refresh:",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"provide new caps in subscription token, Centrifugo will update channel caps."))),(0,o.kt)("li",{parentName:"ul"},"In case of using subscribe proxy \u2013 you can unsubscribe a user (or client) with a resubscribe code. Or disconnect with reconnect code. New capabilities will be set up upon resubscription/reconnection."),(0,o.kt)("li",{parentName:"ul"},"In case of using JWT auth \u2013 revoke token (Centrifugo PRO feature) and unsubscribe/disconnect user (or client) with resubscribe/reconnect code. Upon resubscription/reconnection user will receive an error that token revoked and will try to load a new one.")))}m.isMDXComponent=!0}}]);