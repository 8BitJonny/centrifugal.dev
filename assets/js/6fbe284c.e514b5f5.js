"use strict";(self.webpackChunkcentrifugal_dev=self.webpackChunkcentrifugal_dev||[]).push([[7572],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return f}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},s=Object.keys(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)n=s[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var u=a.createContext({}),l=function(e){var t=a.useContext(u),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=l(e.components);return a.createElement(u.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,s=e.originalType,u=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),d=l(n),f=r,m=d["".concat(u,".").concat(f)]||d[f]||p[f]||s;return n?a.createElement(m,i(i({ref:t},c),{},{components:n})):a.createElement(m,i({ref:t},c))}));function f(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=n.length,i=new Array(s);i[0]=d;var o={};for(var u in t)hasOwnProperty.call(t,u)&&(o[u]=t[u]);o.originalType=e,o.mdxType="string"==typeof e?e:r,i[1]=o;for(var l=2;l<s;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},9473:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return o},contentTitle:function(){return u},metadata:function(){return l},toc:function(){return c},default:function(){return d}});var a=n(2122),r=n(9756),s=(n(7294),n(3905)),i=["components"],o={id:"user_status",title:"User status"},u=void 0,l={unversionedId:"pro/user_status",id:"pro/user_status",isDocsHomePage:!1,title:"User status",description:"Centrifugo provides a presence feature for channels. It works well (for channels with reasonably small number of active subscribers though), but sometimes you need a bit different functionality.",source:"@site/docs/pro/user_status.md",sourceDirName:"pro",slug:"/pro/user_status",permalink:"/docs/pro/user_status",editUrl:"https://github.com/centrifugal/centrifugal.dev/edit/main/docs/pro/user_status.md",version:"current",frontMatter:{id:"user_status",title:"User status"},sidebar:"Pro",previous:{title:"Analytics with ClickHouse",permalink:"/docs/pro/analytics"},next:{title:"Operation throttling",permalink:"/docs/pro/throttling"}},c=[{value:"Update active status",id:"update-active-status",children:[]},{value:"Get user status",id:"get-user-status",children:[]},{value:"Clear user status",id:"clear-user-status",children:[]},{value:"Configuration",id:"configuration",children:[]}],p={toc:c};function d(e){var t=e.components,n=(0,r.Z)(e,i);return(0,s.kt)("wrapper",(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"Centrifugo provides a presence feature for channels. It works well (for channels with reasonably small number of active subscribers though), but sometimes you need a bit different functionality."),(0,s.kt)("p",null,"What if you want to get a specific user status based on its recent activity in application? You can create a personal channel with presence enabled for each user. It will show that user has an active connection with a server. But this won't show whether user did some actions in an appplication recently or just left it open while not actually using it."),(0,s.kt)("p",null,"User status feature of Centrifugo PRO allows calling a special RPC method from a client side when a user makes a useful action in an application (clicks on buttons, uses a mouse \u2013 whatever means that user really uses application at the moment). This call sets a time of last user activity in Redis, and this information can then be queried."),(0,s.kt)("p",null,"The feature can be useful for chat applications when you need to get online/activity status for a list of buddies (Centrifugo supports batch requests to user active status information)."),(0,s.kt)("h3",{id:"update-active-status"},"Update active status"),(0,s.kt)("p",null,"Centrifugo PRO provides a built-in RPC method called ",(0,s.kt)("inlineCode",{parentName:"p"},"updateActiveStatus"),". Call it without any parameters from a client side whenever user performs a useful action that proves it's active status in your app:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-javascript"},"await centrifuge.namedRPC('updateActiveStatus')\n")),(0,s.kt)("div",{className:"admonition admonition-note alert alert--secondary"},(0,s.kt)("div",{parentName:"div",className:"admonition-heading"},(0,s.kt)("h5",{parentName:"div"},(0,s.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,s.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,s.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"}))),"note")),(0,s.kt)("div",{parentName:"div",className:"admonition-content"},(0,s.kt)("p",{parentName:"div"},"Don't forget to debounce calling this method on client side to avoid exposing RPC on every mouse move event for example."))),(0,s.kt)("p",null,"This RPC call sets user's last active time value in Redis (with sharding and Cluster support). Information about active status will be kept in Redis for a configured time interval, then expire."),(0,s.kt)("p",null,"It's also call ",(0,s.kt)("inlineCode",{parentName:"p"},"updateActiveStatus")," using Centrifugo server API RPC extension (for example if you want to force status during application development or you want to proxy status updates over your app backend):"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'curl --header "Content-Type: application/json" \\\n  --header "Authorization: apikey <API_KEY>" \\\n  --request POST \\\n  --data \'{"method": "rpc", "params": {"method": "updateActiveStatus", "params": {"users": ["42"]}}}\' \\\n  http://localhost:8000/api\n')),(0,s.kt)("h3",{id:"get-user-status"},"Get user status"),(0,s.kt)("p",null,"Now on a backend side you have access to a bulk API to effectively get status of particular users."),(0,s.kt)("p",null,"Call RPC method of server API (over HTTP or GRPC):"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'curl --header "Content-Type: application/json" \\\n  --header "Authorization: apikey <API_KEY>" \\\n  --request POST \\\n  --data \'{"method": "rpc", "params": {"method": "getUserStatus", "params": {"users": ["42"]}}}\' \\\n  http://localhost:8000/api\n')),(0,s.kt)("p",null,"You should get a response like this:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "result":{\n        "data":{\n            "statuses":[\n                {\n                    "user":"42",\n                    "active":1627107289,\n                    "online":1627107289\n                }\n            ]\n        }\n    }\n}\n')),(0,s.kt)("p",null,"In case information about last status update time not available the response will be like this:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "result":{\n        "data":{\n            "statuses":[\n                {\n                    "user":"42"\n                }\n            ]\n        }\n    }\n}\n')),(0,s.kt)("p",null,"I.e. status object will present in a response but ",(0,s.kt)("inlineCode",{parentName:"p"},"active")," field won't be set for status object."),(0,s.kt)("p",null,"Also note that Centrifugo also maintains ",(0,s.kt)("inlineCode",{parentName:"p"},"online")," field inside user status object. This field updated periodically by Centrifugo itself while user has active connection with a server. So you can draw ",(0,s.kt)("inlineCode",{parentName:"p"},"away")," statuses in your application: i.e. when user connected but not using application for a long time."),(0,s.kt)("h3",{id:"clear-user-status"},"Clear user status"),(0,s.kt)("p",null,"If you need to clear active status information for some reason there is a ",(0,s.kt)("inlineCode",{parentName:"p"},"deleteUserStatus")," RPC call in server API:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'curl --header "Content-Type: application/json" \\\n  --header "Authorization: apikey <API_KEY>" \\\n  --request POST \\\n  --data \'{"method": "rpc", "params": {"method": "deleteUserStatus", "params": {"users": ["42"]}}}\' \\\n  http://localhost:8000/api\n')),(0,s.kt)("h3",{id:"configuration"},"Configuration"),(0,s.kt)("p",null,"To enable Redis active status feature:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="config.json"',title:'"config.json"'},'{\n    ...\n    "redis_active_status": {\n        "enabled": true,\n        "redis_address": "127.0.0.1:6379"\n    }\n}\n')),(0,s.kt)("p",null,"Redis configuration for throttling feature matches Centrifugo Redis engine configuration. So Centrifugo supports client-side consistent sharding to scale Redis, Redis Sentinel, Redis Cluster for throttling feature too."),(0,s.kt)("p",null,"It's also possible to reuse Centrifugo Redis engine by setting ",(0,s.kt)("inlineCode",{parentName:"p"},"use_redis_from_engine")," option instead of custom throttling Redis address declaration, like this:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="config.json"',title:'"config.json"'},'{\n    ...\n    "engine": "redis",\n    "redis_address": "localhost:6379",\n    "redis_active_status": {\n        "enabled": true,\n        "use_redis_from_engine": true,\n    }\n}\n')),(0,s.kt)("p",null,"In this case Redis active status will simply connect to Redis instances configured for Centrifugo Redis engine."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"expire_interval")," is a ",(0,s.kt)("a",{parentName:"p",href:"../server/configuration#setting-time-duration-options"},"duration")," for how long Redis keys will be kept for each user. Expiration time extended on every update. By default expiration time is 31 day. To set it to 1 day:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-json",metastring:'title="config.json"',title:'"config.json"'},'{\n    ...\n    "redis_active_status": {\n        ...\n        "expire_interval": "24h"\n    }\n}\n')))}d.isMDXComponent=!0}}]);