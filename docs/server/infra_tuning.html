<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9e615eff0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Centrifugo Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Centrifugo Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-204787498-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Infrastructure tuning | Centrifugo</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://centrifugal.dev/docs/server/infra_tuning"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Infrastructure tuning | Centrifugo"><meta data-react-helmet="true" name="description" content="As Centrifugo deals with lots of persistent connections your operating system and server infrastructure must be ready for it."><meta data-react-helmet="true" property="og:description" content="As Centrifugo deals with lots of persistent connections your operating system and server infrastructure must be ready for it."><meta data-react-helmet="true" property="og:image" content="https://centrifugal.dev/img/centrifugo_soc.png"><meta data-react-helmet="true" name="twitter:image" content="https://centrifugal.dev/img/centrifugo_soc.png"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://centrifugal.dev/docs/server/infra_tuning"><link data-react-helmet="true" rel="alternate" href="https://centrifugal.dev/docs/server/infra_tuning" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://centrifugal.dev/docs/server/infra_tuning" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.3d015319.css">
<link rel="preload" href="/assets/js/runtime~main.7d82a0c8.js" as="script">
<link rel="preload" href="/assets/js/main.ce76ab56.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_2qcr"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Centrifugo Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Centrifugo Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">Centrifugo</b></a><a class="navbar__item navbar__link" href="/docs/getting-started/introduction">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/server/configuration">Server guide</a><a class="navbar__item navbar__link" href="/docs/transports/overview">Transports</a><a class="navbar__item navbar__link" href="/docs/ecosystem/client">Ecosystem</a><a class="navbar__item navbar__link" href="/docs/pro/overview">Centrifugo PRO</a><a class="navbar__item navbar__link" href="/docs/faq/index">FAQ</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/centrifugal/centrifugo" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search searchBarContainer_MM2z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_s5VG searchBarLoadingRing_2jQk"><div></div><div></div><div></div><div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button" title="Scroll to top"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo sidebarWithHideableNavbar_267A"><a tabindex="-1" class="sidebarLogo_3h0W" href="/"><img src="/img/logo.svg" alt="Centrifugo Logo" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/img/logo.svg" alt="Centrifugo Logo" class="themedImage_1VuW themedImage--dark_hz6m"><b>Centrifugo</b></a><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/server/configuration">Configure Centrifugo</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/console_commands">Console commands</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/server_api">Server API</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/authentication">Client authentication</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/channels">Channels</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/private_channels">Private channels</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/server_subs">Server-side subscriptions</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/engines">Engines, scalability</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/proxy">Proxy to backend</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/history_and_recovery">History and recovery</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/admin_web">Admin web UI</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/monitoring">Monitoring</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" href="/docs/server/infra_tuning">Infrastructure tuning</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/load_balancing">Load Balancing</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/tls">Configure TLS</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/server/codes">Error and disconnect codes</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="markdown"><header><h1 class="h1Heading_27L5">Infrastructure tuning</h1></header><p>As Centrifugo deals with lots of persistent connections your operating system and server infrastructure must be ready for it.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="open-files-limit"></a>Open files limit<a class="hash-link" href="#open-files-limit" title="Direct link to heading">#</a></h3><p>You should increase a max number of open files Centrifugo process can open if you want to handle more connections.</p><p>To get the current open files limit run:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">ulimit -n</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>On Linux you can check limits for a running process using:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cat /proc/&lt;PID&gt;/limits</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The open file limit shows approximately how many clients your server can handle. Each connection consumes one file descriptor. On most operating systems this limit is 128-256 by default.</p><p>See <a href="https://docs.riak.com/riak/kv/2.2.3/using/performance/open-files-limit.1.html" target="_blank" rel="noopener noreferrer">this document</a> to get more info on how to increase this number.</p><p>If you install Centrifugo using RPM from repo then it automatically sets max open files limit to 65536.</p><p>You may also need to increase max open files for Nginx (or any other proxy before Centrifugo).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="ephemeral-port-exhaustion"></a>Ephemeral port exhaustion<a class="hash-link" href="#ephemeral-port-exhaustion" title="Direct link to heading">#</a></h3><p>Ephemeral ports exhaustion problem can happen between your load balancer and Centrifugo server. If your clients connect directly to Centrifugo without any load balancer or reverse proxy software between then you are most likely won&#x27;t have this problem. But load balancing is a very common thing.</p><p>The problem arises due to the fact that each TCP connection uniquely identified in the OS by the 4-part-tuple:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">source ip | source port | destination ip | destination port</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>On load balancer/server boundary you are limited in 65536 possible variants by default. Actually due to some OS limits not all 65536 ports are available for usage (usually about 15k ports available by default).</p><p>In order to eliminate a problem you can:</p><ul><li>Increase the ephemeral port range by tuning <code>ip_local_port_range</code> option</li><li>Deploy more Centrifugo server instances to load balance across</li><li>Deploy more load balancer instances</li><li>Use virtual network interfaces</li></ul><p>See <a href="https://making.pusher.com/ephemeral-port-exhaustion-and-how-to-avoid-it/" target="_blank" rel="noopener noreferrer">a post in Pusher blog</a> about this problem and more detailed solution steps.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="sockets-in-time_wait-state"></a>Sockets in TIME_WAIT state<a class="hash-link" href="#sockets-in-time_wait-state" title="Direct link to heading">#</a></h3><p>On load balancer/server boundary one more problem can arise: sockets in TIME_WAIT state.</p><p>Under load when lots of connections and disconnections happen socket descriptors can stay in TIME_WAIT state. Those descriptors can not be reused for a while. So you can get various
errors when using Centrifugo. For example something like <code>(99: Cannot assign requested address) while connecting to upstream</code> in Nginx error log and 502 on client side.</p><p>Look how many socket descriptors in TIME_WAIT state.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#bfc7d5"><span class="token plain">netstat -an |grep TIME_WAIT | grep &lt;CENTRIFUGO_PID&gt; | wc -l</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Nice article about TIME_WAIT sockets: <a href="http://vincent.bernat.im/en/blog/2014-tcp-time-wait-state-linux.html" target="_blank" rel="noopener noreferrer">http://vincent.bernat.im/en/blog/2014-tcp-time-wait-state-linux.html</a></p><p>The advices here are similar to ephemeral port exhaustion problem:</p><ul><li>Increase the ephemeral port range by tuning <code>ip_local_port_range</code> option</li><li>Deploy more Centrifugo server instances to load balance across</li><li>Deploy more load balancer instances</li><li>Use virtual network interfaces</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="proxy-max-connections"></a>Proxy max connections<a class="hash-link" href="#proxy-max-connections" title="Direct link to heading">#</a></h3><p>Proxies like Nginx and Envoy have default limits on maximum number of connections which can be established.</p><p>Make sure you have a reasonable limit for max number of incoming and outgoing connections in your proxy configuration. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="conntrack-table"></a>Conntrack table<a class="hash-link" href="#conntrack-table" title="Direct link to heading">#</a></h3><p>More rare (since default limit is usually sufficient) your possible number of connections can be limited by conntrack table. Netfilter framework which is part of iptables keeps information about all connections and has limited size for this information. See how to see its limits and instructions to increase <a href="https://morganwu277.github.io/2018/05/26/Solve-production-issue-of-nf-conntrack-table-full-dropping-packet/" target="_blank" rel="noopener noreferrer">in this article</a>.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><a href="https://github.com/centrifugal/centrifugal.dev/edit/main/docs/server/infra_tuning.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_3DPF"></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/server/monitoring"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Monitoring</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/server/load_balancing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Load Balancing Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#open-files-limit" class="table-of-contents__link">Open files limit</a></li><li><a href="#ephemeral-port-exhaustion" class="table-of-contents__link">Ephemeral port exhaustion</a></li><li><a href="#sockets-in-time_wait-state" class="table-of-contents__link">Sockets in TIME_WAIT state</a></li><li><a href="#proxy-max-connections" class="table-of-contents__link">Proxy max connections</a></li><li><a href="#conntrack-table" class="table-of-contents__link">Conntrack table</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contacts</div><ul class="footer__items"><li class="footer__item"><a href="mailto:centrifugal.dev@gmail.com" target="_blank" rel="noopener noreferrer" class="footer__link-item">Send e-mail</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/centrifugal/centrifugo/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Issues<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://t.me/joinchat/U57MI8Lam9mhpuhd" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discord.gg/tYgADKx" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/attributions">Attributions</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Centrifugal.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.7d82a0c8.js"></script>
<script src="/assets/js/main.ce76ab56.js"></script>
</body>
</html>